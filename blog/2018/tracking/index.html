<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="/blog/css/blog.css">
  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="/blog/2018/tracking/js/example_tracking.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Press+Start+2P&display=swap" rel="stylesheet">

  <title>
    ✨ Blog | Tracking you ✨
  </title>

</head>

<body>
  <article class="post">
    <blockquote> 
      <h1>Collecting user data</h1>
    </blockquote>
    <p>For my thesis that ended up being about using collected browser behaviour from visitors to improve user experience for websites and apps, 
      I spent some time researching what kind of data can, and can not be collected, aswell as the limitations set by law. </p>

      <p>Please note that all the code on this page was written in 2016/17 and might not be applicable anymore. 
        You will find the full code as a download at the bottom of the page. For now, let start simple.</p>


      <h4>Where are we and where did we come from</h4>
      <figcaption>Input:</figcaption>
      <pre class="codeblock prettyprint">
        <code>
            var currentPage = window.location.href;
            var referPage   = document.referrer;
        </code>
      </pre>
      <figcaption>Output:</figcaption>
      <textarea rows="1" class="console-output" id="output1" ></textarea>
      <div class="tip tip-right">
        <p>MDN <br>
          <a class="" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/location">window.location.href</a> 
          <a class="" href="https://developer.mozilla.org/en-US/docs/Web/API/Document/referrer">document.referrer</a> 
        </p>
      </div>
      <p>
        the window.location tells us where we are and the document.referrer tels us where we came from, 
        if you get an empty result from the document referer it might be possible this page opened in a new tab.
      </p>

      <h4>Timing the duration of a page load</h4>


      <p>
        Now this is not as reliable as actual load testing, but it might give you some insights so why not. We can start by setting a timer as the first 'action' of a page load, and set a timer when the page is actually done loading like so. 

        <pre class="codeblock prettyprint">
          <code>
            var loadTimerStart = Date.now();
            document.addEventListener('DOMContentLoaded', function(){
              var loadTimerEnd    = Date.now();
              var loadTimerResult = loadTimerEnd - loadTimerStart;
            });
          </code>
        </pre>
        <figcaption>Output:</figcaption>
        <textarea rows="1" class="console-output" id="output2" ></textarea>
        <h4>What kind of device is being used</h4>
        <p>
          
        </p>

        <pre class="codeblock prettyprint">
          <code>
            /**
            *  creates getBrowserType() @function
            *  @returns {string} type of browser
            *  used to identify the browser types [];
            */
        
           getBrowserType = (function(){
               var ua= navigator.userAgent, tem,
               M= ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
               if(/trident/i.test(M[1])){
                   tem=  /\brv[ :]+(\d+)/g.exec(ua) || [];
                   return 'IE '+(tem[1] || '');
               };
               if(M[1]=== 'Chrome'){
                   tem= ua.match(/\b(OPR|Edge)\/(\d+)/);
                   if(tem!= null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
               };
               M= M[2]? [M[1], M[2]]: [navigator.appName, navigator.appVersion, '-?'];
               if((tem= ua.match(/version\/(\d+)/i))!= null) M.splice(1, 1, tem[1]);
               return M.join(' ');
           })();
          </code>
        </pre>
        <figcaption>By applying regex we can parse the useragent to have a clean representation of our browsers version </figcaption>
        <pre class="codeblock prettyprint">
          <code>

            /**
            *  @function @returns {boolean} based on matching in the userAgent
            *  
            */
               var isMobile = {
                   Android: function() {
                       return navigator.userAgent.match(/Android/i);
                   },
                   BlackBerry: function() {
                       return navigator.userAgent.match(/BlackBerry/i);
                   },
                   iPad: function() {
                       return navigator.userAgent.match(/iPad/i);
                   },
                   iPhone: function() {
                       return navigator.userAgent.match(/iPhone/i);
                   },    
                   Opera: function() {
                       return navigator.userAgent.match(/Opera Mini/i);
                   },
                   Windows: function() {
                       return navigator.userAgent.match(/IEMobile/i);
                   },
                   any: function() {
                       return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
                   }
               };
           /**
            *  call  @function isMobile and @returns {string}
            *  save  @return value as mobileType
            */
               var getMobileType = function(){
                   if(isMobile.Android()){
                       return'Android';
                   }else if(isMobile.Opera()){
                       return 'Opera';
                   }else if (isMobile.BlackBerry()){
                       return 'BlackBerry';
                   }else if(isMobile.iPad()){
                       return 'iPad';
                   }else if(isMobile.iPhone()){
                       return'iPhone';
                   }else if(isMobile.Windows()){
                       return 'Windows mobile';
                   }else{
                       return "none"
                   }  
               }
           
          </code>
        </pre>
        <figcaption>By doing a short match we can filterout different mobile devices, remember blackberry anyone?</figcaption>



        <pre class="codeblock prettyprint">
          <code>
            var browserType    = getBrowserType();
            var browserVersion = navigator.appVersion;
            var mobileUser     = getMobileType()
          </code>
        </pre>

        <textarea rows="2" class="console-output" id="output3" ></textarea>
        <p> By parsing the user agent we can split it up into multiple usefull segments, the issue with this is that as time goes on - they might lose its reliability. </p>


        <h4>What about operating systems?</h4>
        <pre class="codeblock prettyprint">
          <code>
            var identifyOS = function(){
              var OSName = "Unknown OS"; // fallback
              if (navigator.userAgent.indexOf("Win") != -1) OSName="Windows";
              if (navigator.userAgent.indexOf("Mac") != -1) OSName="Macintosh";
              if (navigator.userAgent.indexOf("Linux") != -1) OSName="Linux";
              if (navigator.userAgent.indexOf("Android") != -1) OSName="Android";
              if (navigator.userAgent.indexOf("like Mac") != -1) OSName = "iOS";
              if (navigator.userAgent.match(/SAMSUNG|SGH-[I|N|T]|GT-[I|P|N]|SM-[N|P|T|Z|G]|SHV-E|SCH-[I|J|R|S]|SPH-L/i))OSName = "SamsungOS";
              return OSName
          }
          </code>
        </pre>
        <figcaption>A simple switch to create a nice OS name, again based on the userAgent</figcaption>

        <pre class="codeblock prettyprint">
          <code>
            var osSystem       = identifyOS()
            var osPlatform     = navigator.platform
          </code>
        </pre>
        <textarea rows="2" class="console-output" id="output4" ></textarea>

        <h4>What about screen and window sizes ? </h4>
        <pre class="codeblock prettyprint">
          <code>
            /**
            *   @plain javascript way of doing $(window).width();
            *   [tested in:  Chrome - Safari]
            */
            var getWindowWidth = function(){
                return window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
            };
            /**
            *   @plain javascript way of doing $(window).height();
            *   [tested in:  Chrome - Safari]
            */
            var getWindowHeight = function(){
                return window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
            };
            /**
            *  @function getScreenHeight @returns screen.height from screen object
            */
            var getScreenHeight = function(){
                return screen.height;
            };
            /**
            *  @function getScreenWidth @returns screen.width from screen object
            */
            var getScreenWidth = function(){
                return screen.width;
            };
            
          </code>
        </pre>
        <figcaption></figcaption>

        <pre class="codeblock prettyprint">
          <code>
            var windowHeight   = getWindowHeight()
            var windowWidth    = getWindowWidth()
            var screenWidth    = getScreenWidth()
            var screenHeight   = getScreenHeight()
          </code>
        </pre>

        <textarea rows="2" class="console-output" id="output5" ></textarea>


        <h4>Seeing how far the user has scrolled on your current page</h4>
        <pre class="codeblock prettyprint">
          <code>
            /**
            * @function getScrollPercent returns @var % scrolled on current page
            * @thanks https://stackoverflow.com/questions/2387136/cross-browser-method-to-determine-vertical-scroll-percentage-in-javascript
            * Going to need to see the first position ( what we get now) AND the last position firstposition + (the viewheight) to see what the
            * extend of the user's visable spectrum is.  --> getWindowHeight()
            */
              function getScrollPercent() {
                  var h = document.documentElement, 
                  b = document.body,
                  st = 'scrollTop',
                  sh = 'scrollHeight';
                  return (h[st]||b[st]) / (h[sh]||b[sh]) * 100
              }
          </code>
        </pre>

        <pre class="codeblock prettyprint">
          <code>
            var scrollPercentage = getScrollPercent()
          </code>
        </pre>
        <figcaption>By intervalling this and checking to see if the next itteration is larger than our previous, we can get a max scroll percentage on the page.</figcaption>

        <textarea rows="2" class="console-output" id="output6" ></textarea>

        <h4>Keeping track of the user interaction - clicks on page</h4>
        <pre class="codeblock prettyprint">
          <code>
            var coordContainer = [];
            document.addEventListener("click", getCoordOnClick);
            var getCoordOnClick = function(event){
                coordContainer.push({
                    "x": event.clientX,
                    "y": event.clientY
                });
            };
          </code>
        </pre>
        <figcaption>Simple but effective</figcaption>
        <textarea rows="2" class="console-output" id="output7" ></textarea>




                        <blockquote>
                          <h6></h6>
                        </blockquote>
                        <p>Work in Progress</p>
                        <p>As usually you can find the fullcode linked at the end.</p>


                        
                        <!-- <blockquote>
                          <h6>Sending the data to your server</h6>
                        </blockquote>

                        <p>When I started playing with user tracking, I've tried to (ab)use the window.onbeforeunload function to not only time the end of a visit, but send the data back to my server.. that was a mistake - 
                          you are not supposed to use it in that way and device/browser compatability is extremly poor, so I had to came up with something more realistic. 
                          Note: These original diagrams got lost, these were created for this artice.</p>

                          <p>Polling</p>
                          <p>We can time the duration of a visit by having your visitors send an 'I am alive' message every N seconds to the server. like so: </p>

                          <figure class="center">
                            <img src="/blog/2018/tracking/resources/pollingserver.PNG" alt="Big Ass Image">
                            <figcaption>Polling means sending a lot of extra data and requires extra server resources especially if it has to do additional data manipulation</figcaption>
                          </figure>  


                          <p>Something like local poling + first in first out?</p>
                          <p>A simple solution is to use polling on the front end, store all the information there - and when the user reaches a new page, 
                            send all the collected data from the previous page to the webserver. Something like:</p> -->






      <p></p>
      <p></p>
    <div class="tip tip-right"> 
      <p>Evercookie is made by the legendary Sammy<br>
        <a class="" href="https://samy.pl">Learn more</a> 
      </p>
    </div>
 

  </article>
  <div id="disqus_thread"></div>

  <script>
   
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://heijnendev.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <script id="dsq-count-scr" src="//heijnendev.disqus.com/count.js" async></script>       
</body>

</html>